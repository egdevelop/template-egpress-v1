---
import BaseLayout from './BaseLayout.astro';
import AuthorCard from '../components/AuthorCard.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import ShareButtons from '../components/ShareButtons.astro';
import AdPlacement from '../components/AdPlacement.astro';
import type { CollectionEntry } from 'astro:content';

interface Props {
  post: CollectionEntry<'blog'>;
  relatedPosts?: CollectionEntry<'blog'>[];
}

const { post, relatedPosts = [] } = Astro.props;
const { title, description, pubDate, author, category, featuredImage } = post.data;

function formatDate(date: Date): string {
  return date.toLocaleDateString('en-US', {
    day: 'numeric',
    month: 'short',
    year: 'numeric'
  });
}

function getReadingTime(content: string): number {
  const wordsPerMinute = 200;
  const words = content.split(/\s+/).length;
  return Math.ceil(words / wordsPerMinute);
}

const readingTime = getReadingTime(post.body || '');
---

<BaseLayout 
  title={title} 
  description={description}
  image={featuredImage}
  type="article"
  publishedTime={pubDate.toISOString()}
  author={author.name}
>
  <article class="max-w-4xl mx-auto px-4 py-12">
    <!-- Article Header -->
    <header class="mb-8">
      <div class="flex items-center gap-3 mb-4">
        <span class={`tag tag-${category}`}>{category.replace('-', ' ')}</span>
        <span class="text-gray-400">â€¢</span>
        <span class="text-sm text-gray-500">{readingTime} min read</span>
      </div>
      
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-6 leading-tight">
        {title}
      </h1>
      
      <p class="text-xl text-gray-600 mb-6">
        {description}
      </p>
      
      <div class="flex items-center justify-between flex-wrap gap-4 pb-8 border-b border-gray-200">
        <div class="flex items-center gap-3">
          <img 
            src={author.avatar || `https://ui-avatars.com/api/?name=${encodeURIComponent(author.name)}&background=E11D48&color=fff&size=40`}
            alt={author.name}
            class="w-10 h-10 rounded-full"
            loading="lazy"
            width="40"
            height="40"
          />
          <div>
            <p class="font-medium text-gray-900">{author.name}</p>
            <p class="text-sm text-gray-500">{formatDate(pubDate)}</p>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Featured Image -->
    {featuredImage && (
      <figure class="mb-10 -mx-4 md:mx-0">
        <img 
          src={featuredImage}
          alt={title}
          class="w-full h-auto rounded-xl object-cover aspect-video"
          loading="eager"
          width="1200"
          height="675"
        />
      </figure>
    )}

    <!-- Ad Placement: After Featured Image -->
    <AdPlacement type="horizontal" slot="post-top" />
    
    <!-- Article Content -->
    <div class="prose mx-auto">
      <slot />
    </div>

    <!-- Ad Placement: After Content -->
    <AdPlacement type="in-article" slot="post-bottom" />
    
    <!-- Share Buttons -->
    <div class="mt-12 pt-8 border-t border-gray-200">
      <ShareButtons title={title} url={Astro.url.href} />
    </div>
    
    <!-- Author Card -->
    <div class="mt-12">
      <AuthorCard author={author} />
    </div>
  </article>
  
  <!-- Ad Placement: Before Related Posts -->
  <div class="max-w-4xl mx-auto px-4">
    <AdPlacement type="horizontal" slot="before-related" />
  </div>

  <!-- Related Posts -->
  {relatedPosts.length > 0 && (
    <section class="bg-white py-16">
      <div class="max-w-6xl mx-auto px-4">
        <h2 class="text-2xl font-bold mb-8">You May Also Like</h2>
        <RelatedPosts posts={relatedPosts} />
      </div>
    </section>
  )}
</BaseLayout>
